# HTML粘贴图片自动上传功能 - 测试指南

## 功能概述

编辑器现在支持从HTML内容中自动提取和上传图片到Cloudinary，支持以下场景：

1. **直接粘贴图片文件** ✓ （原有功能，保持不变）
2. **粘贴包含图片的HTML内容** ✓ （新增功能）
3. **处理多种图片格式**：
   - 远程URL图片（HTTP/HTTPS）
   - Base64编码图片
   - 相对路径图片

## 使用场景

### 场景1：从微信公众号复制文章

1. 打开微信公众号文章
2. 在浏览器中全选内容（Ctrl+A 或 Cmd+A）
3. 复制（Ctrl+C 或 Cmd+C）
4. 粘贴到编辑器（Ctrl+V 或 Cmd+V）
5. 系统自动：
   - 检测HTML中的所有图片
   - 逐个下载图片
   - 上传到Cloudinary
   - 替换原始URL为Cloudinary链接
   - 显示上传进度："正在处理粘贴内容... (3/5 张图片)"

### 场景2：从网页复制包含图片的文章

1. 选中网页内容
2. 复制HTML
3. 粘贴到编辑器
4. 享受自动处理体验

### 场景3：粘贴包含Base64图片的内容

- 支持Word/富文本编辑器中复制的内容
- 自动转换Base64为标准图片文件
- 上传到Cloudinary

## 测试清单

### 功能测试

- [ ] 粘贴包含1张图片的HTML
  - 预期：图片自动上传并显示

- [ ] 粘贴包含5张以上图片的HTML
  - 预期：按最多3个并发上传，显示进度

- [ ] 粘贴包含Base64图片的内容
  - 预期：Base64转换为文件后上传

- [ ] 粘贴包含相对路径图片的HTML
  - 预期：尝试转换为绝对路径后上传

- [ ] 粘贴包含失败图片的HTML（无效URL等）
  - 预期：失败的图片被移除，其他图片正常显示

### 错误处理测试

- [ ] 网络中断时粘贴HTML
  - 预期：显示错误提示，可重新粘贴

- [ ] 超大图片（>5MB）
  - 预期：显示错误，图片被移除

- [ ] CORS限制的图片
  - 预期：图片无法下载时被移除

- [ ] 空HTML内容
  - 预期：正常插入，无错误

### 性能测试

- [ ] 粘贴10张图片的HTML
  - 预期：正常处理，显示进度

- [ ] 粘贴20张图片的HTML
  - 预期：正常处理，显示进度

- [ ] 粘贴50张图片的HTML
  - 预期：限制为前20张，其他图片被移除（可选限制）

## 手动测试步骤

### 快速测试

1. 打开 http://localhost:3000/admin/new（需要登录）
2. 准备HTML内容（可以从任何网页复制）
3. 在编辑器中粘贴
4. 观察进度提示
5. 验证图片是否正确显示和上传

### 检查上传结果

1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 再次进行粘贴操作
4. 查看 `/api/upload` 请求
5. 确保请求成功（200 状态码）
6. 检查响应中的Cloudinary URL

## 已知限制

1. **相对路径图片**：如果无法判断来源域名，可能无法正确转换为绝对路径
2. **防盗链图片**：某些设有防盗链的图片可能下载失败（如微信公众号防盗链）
3. **速度限制**：最多并发3个上传以避免服务器过载
4. **大小限制**：单张图片最大5MB

## 调试建议

### 查看浏览器控制台

打开开发者工具控制台，可以看到详细的错误信息：

```
图片上传失败 (https://example.com/image.jpg): HTTP 404
HTML粘贴处理失败: Error: 上传响应中缺少URL
```

### 检查网络请求

在 Network 标签中：
1. 查看图片下载请求（可能CORS失败）
2. 查看 `/api/upload` 请求的响应
3. 检查Cloudinary返回的URL

## 常见问题

### Q: 粘贴后没有反应？
A: 检查是否是图片文件粘贴（这种情况走另一条路径）。如果是HTML，等待上传完成。

### Q: 某些图片没有上传成功？
A: 查看浏览器控制台的错误信息，可能是CORS或防盗链问题。这是正常的，系统会自动移除失败的图片。

### Q: 上传太慢了？
A: 系统限制了并发数为3，这是为了避免API限制。可以在 `lib/imageProcessor.ts` 中修改 `MAX_CONCURRENT_UPLOADS` 常量。

## 开发者注意事项

### 修改配置

编辑 `lib/imageProcessor.ts` 中的常量：

```typescript
const IMAGE_MAX_SIZE = 5 * 1024 * 1024        // 单张图片最大5MB
const DOWNLOAD_TIMEOUT = 5000                 // 下载超时5秒
const MAX_CONCURRENT_UPLOADS = 3              // 最多并发3个上传
```

### 添加自定义处理

在 `components/TipTapEditor.tsx` 中的 `processHtmlPaste` 函数中可以添加自定义逻辑。

### 错误处理改进

当前实现会：
1. 捕获所有错误并记录到控制台
2. 移除失败的图片
3. 显示用户友好的错误提示

可以进一步改进为：
1. 记录失败的URL列表
2. 提供重试选项
3. 记录到服务器日志
